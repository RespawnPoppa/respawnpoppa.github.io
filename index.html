<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTA III</title>
    <style>
        canvas {
            background-color: white;
            border-color: black;
            border-style: solid;
        }

        body {
            background-color: black;
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>

    <canvas id="myCanvas" width="1158" height="808"></canvas>
    <script>
        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext('2d');

        // Función para solicitar la animación
        window.requestAnimationFrame = (function () {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                function (callback) {
                    window.setTimeout(callback, 17);
                };
        }());

        // Cargar la imagen de fondo
        const imagenFondo = new Image();
        imagenFondo.src = "img/map.png";
        imagenFondo.onload = () => {
            ctx.drawImage(imagenFondo, 0, 0, canvas.width, canvas.height);
        };

        //HUD (Adorno)
        var hud = new Image();
        hud.src = "img/HUD.png";
        var radar = new Image();
        radar.src = "img/radar.png";

        // Declaraciones generales o de otro usos
        var tx = 0, ty = 0;
        var moving = false;
        var x = 516, y = 564, dir = 0, speed = 4;
        var currentRightSprite = 0;
        var animationInterval;
        var currentLeftSprite = 0;
        var animationIntervalLeft;
        var currentUpSprite = 0;
        var animationIntervalUp;
        var currentDownSprite = 0;
        var animationIntervalDown;

        // Musica de fondo y sonido de carros
        var music = new Audio("musicGTA3.mp3");
        music.play();
        var carSound = new Audio("sonidoCarro.mp3");

        function playCarSound() {
            carSound.play();
            setTimeout(playCarSound, 20000);
        }
        playCarSound();

        // Variables para el uso de los sprite imágenes del jugador
        var playerSprites = {
            up: [new Image(), new Image()],
            down: [new Image(), new Image()],
            left: [new Image(), new Image()],
            right: [new Image(), new Image()],
            stop: new Image(),
            stopRight: new Image(),
            stopLeft: new Image(),
            stopUp: new Image(),
            stopDown: new Image()
        };
        playerSprites.up[0].src = "img/playerRun3.png";
        playerSprites.up[1].src = "img/playerRun3.1.png";
        playerSprites.down[0].src = "img/playerRun4.png";
        playerSprites.down[1].src = "img/playerRun4.1.png"
        playerSprites.left[0].src = "img/playerRun2.png";
        playerSprites.left[1].src = "img/playerRun2.1.png";
        playerSprites.right[0].src = "img/playerRun1.png";
        playerSprites.right[1].src = "img/playerRun1.1.png";
        playerSprites.up[0].src = "img/playerRun3.png";
        playerSprites.up[1].src = "img/playerRun3.1.png";
        playerSprites.stop.src = "img/spriteParado.png";
        playerSprites.stopRight.src = "img/spriteParadoRight.png";
        playerSprites.stopLeft.src = "img/spriteParadoLeft.png";
        playerSprites.stopUp.src = "img/spriteParado.png"
        playerSprites.stopDown.src = "img/spriteParadoDown.png";

        // Declaraciones de variables para el uso de los sprite imágenes de los autos
        var auto = new Image();
        auto.src = "img/autoI.png";
        var auto2 = new Image();
        auto2.src = "img/autoII.png";
        var auto3 = new Image();
        auto3.src = "img/autoIII.png";
        var auto4 = new Image();
        auto4.src = "img/autoIV.png";

        var squareX = 0;
        var squareSpeed = 8;
        var squareSpeed2 = 12;
        var squareSpeed3 = 15;
        var canvasWidth = canvas.width;
        var anchoAutoI = 190;
        var altoAutoI = 80;

        // Definición de valores de colisión para los autos
        var squareSize = 50;
        var positionAutoY = canvas.height / 1.90 - squareSize / 1.90;
        var positionAutoY2 = canvas.height / 2.4 - altoAutoI / 2.4;
        var positionAutoY3 = canvas.height / 3.4 - altoAutoI / 3.4;
        var positionAutoY4 = canvas.height / 6 - altoAutoI / 6;
        var squareX2 = canvasWidth;
        var squareX3 = canvasWidth;
        var squareX4 = canvasWidth;



        // Controles del jugador
        document.addEventListener("keydown", (e) => {
            if (!moving) {
                moving = true;
                switch (e.keyCode) {
                    case 87:
                        dir = 1;
                        break;
                    case 83:
                        dir = 2;
                        break;
                    case 68:
                        dir = 3;
                        break;
                    case 65:
                        dir = 4;
                        break;
                }
            }
        });

        document.addEventListener("keyup", (e) => {
            moving = false;
            clearInterval(animationInterval);
            clearInterval(animationIntervalLeft);
            clearInterval(animationIntervalDown);
            clearInterval(animationIntervalUp);

            currentRightSprite = 0;
            currentLeftSprite = 0;
            currentDownSprite = 0;
            currentUpSprite = 0;

            switch (e.keyCode) {
                case 68:
                    dir = 6;
                    break;
                case 65:
                    dir = 7;
                    break;
                default:
                    dir = 0;
                    break;
            }
        });
        
        // Función para actualizar el juego y los efectos de colisión o actualización fotograma
        function update() {
            if (moving) {
                if (dir == 1 && y > 0) {
                    y -= speed;
                    animationIntervalUp = setInterval(() => {
                        currentUpSprite = (currentUpSprite + 1) % 2;
                    }, 160)
                }
                if (dir == 2 && y + 50 < canvas.height) {
                    y += speed;

                    animationIntervalDown = setInterval(() => {
                        currentDownSprite = (currentDownSprite + 1) % 2;
                    }, 160)
                }
                if (dir == 3 && x + 50 < canvas.width) {
                    x += speed;
                    animationInterval = setInterval(() => {
                        currentRightSprite = (currentRightSprite + 1) % 2;
                    }, 160);
                }
                if (dir == 4 && x > 0) {
                    x -= speed;
                    animationIntervalLeft = setInterval(() => {
                        currentLeftSprite = (currentLeftSprite + 1) % 2;
                    }, 160);
                }
            }

            // Colisión con el objetivo (carro1)
            if (
                x < squareX + squareSize &&
                x + 50 > squareX &&
                y < positionAutoY + squareSize &&
                y + 50 > positionAutoY
            ) {
                console.log("Colisión con el objetivo (carro1)");
                x = 516;
                y = 564;
            }

            // Colisión con el objetivo (carro2)
            if (
                x < squareX2 + squareSize &&
                x + 50 > squareX2 &&
                y < positionAutoY2 + squareSize &&
                y + 50 > positionAutoY2
            ) {
                console.log("Colisión con el objetivo (carro2)");
                x = 516;
                y = 564;
            }

            // Colisión con el objetivo (carro3)
            if (
                x < squareX3 + squareSize &&
                x + 50 > squareX3 &&
                y < positionAutoY3 + squareSize &&
                y + 50 > positionAutoY3
            ) {
                console.log("Colisión con el objetivo (carro3)");
                x = 516;
                y = 564;
            }
            // Colisión con el objetivo (carro4)
            if (
                x < squareX4 + squareSize &&
                x + 50 > squareX4 &&
                y < positionAutoY4 + squareSize &&
                y + 50 > positionAutoY4
            ) {
                console.log("Colisión con el objetivo (carro4)");
                x = 516;
                y = 564;
            }

            squareX += squareSpeed;

            if (squareX > canvasWidth) {
                squareX = -squareSize;
            }

            moveAuto2();
            moveAuto3();
            moveAuto4();
            drawScene();
            window.requestAnimationFrame(update);
        }

        // Función para dibujar la escena y la pintura del juego
        function drawScene() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(imagenFondo, 0, 0, canvas.width, canvas.height);
            ctx.drawImage(hud, 880, 0, 260, 105);
            ctx.drawImage(radar, 40, 640, 180, 160)

            ctx.drawImage(auto, squareX, positionAutoY, anchoAutoI, altoAutoI);
            ctx.drawImage(auto2, squareX2, positionAutoY2, anchoAutoI, altoAutoI);
            ctx.drawImage(auto3, squareX3, positionAutoY3, anchoAutoI, altoAutoI);
            ctx.drawImage(auto4, squareX4, positionAutoY4, anchoAutoI, altoAutoI)

            switch (dir) {
                case 1:
                    ctx.drawImage(playerSprites.up[currentUpSprite], x, y, 50, 50);
                    break;
                case 2:
                    ctx.drawImage(playerSprites.down[currentDownSprite], x, y, 50, 50);
                    break;
                case 3:
                    ctx.drawImage(playerSprites.right[currentRightSprite], x, y, 50, 50);
                    break;
                case 4:
                    ctx.drawImage(playerSprites.left[currentLeftSprite], x, y, 50, 50);
                    break;
                case 5:
                    ctx.drawImage(playerSprites.stopUp, x, y, 50, 50)
                    break;
                case 6:
                    ctx.drawImage(playerSprites.stopRight, x, y, 50, 50);
                    break;
                case 7:
                    ctx.drawImage(playerSprites.stopLeft, x, y, 50, 50);
                    break;
                case 8:
                    ctx.drawImage(playerSprites.stopDown, x, y, 50, 50)
                    break;
                default:
                    ctx.drawImage(playerSprites.stop, x, y, 50, 50);
                    break;
            }
        }

        //Funciones para mover el objeto de los carros izquierda a derecha
        function moveAuto2() {
            squareX2 -= squareSpeed;
            if (squareX2 + anchoAutoI < 0) {
                squareX2 = canvasWidth;
            }
        }

        function moveAuto3() {
            squareX3 += squareSpeed2;
            if (squareX3 > canvas.width) {
                squareX3 = -anchoAutoI;
            }
        }

        function moveAuto4() {
            squareX4 -= squareSpeed3;
            if (squareX4 + anchoAutoI < 0) {
                squareX4 = canvasWidth;
            }
        }

        update();
    </script>
</body>

</html>